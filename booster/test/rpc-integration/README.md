# How to use these tests manually

## Organisation of test files

Each set of tests resides in a directory `test-NAME`, and relates to a kore definition in `resources/NAME.kore`. This definition file is either checked in or must be generated by running script `resources/NAME.kompile` (which typically would compile the respective `resources/NAME.k` file).

Each test in `test-NAME` consists of a "file set":

* `state-TESTNAME.SUFFIX` contains the state to rewrite from, in Kore JSON format. `SUFFIX` is either `execute`, `simplify`, or `send`, and the respective method will be used by the `kore-rpc-client`.
* `response-TESTNAME.json` contains the expected server response. The file is formatted for readability, in a way that the `kore-rpc-client` application expects.
* (optionally) `params-TESTNAME.json` contains additional parameters (as a json object)

## How to run a test

To run a test from a test directory, do the following:

- for example, run the `zero-steps` test from `test-a-to-f`
- assuming the build output directory `.build/booster/bin` is on your path

1) In one terminal, start the rpc server with the definition `resources/NAME.kore`:

```
$ booster test/rpc-integration/resources/a-to-f.kore --module TEST
```

2) In another terminal, send requests with the respective state and parameters using the `kore-rpc-client` tool. For example, if the state file ends in `execute`, send an `execute` request like this:

```
kore-rpc-client \
    --execute state-zero-steps.execute \
    --param-file params-zero-steps.json \
    --expect response-zero-steps.json
```

NOTE: You may need to specify `--host 127.0.0.1` on Arch Linux.

3) Repeat step 2 for all tests you want to run, using `kore-rpc-client` modes indicated by the file suffixes (`execute`, `simplify`, `send`).

4) Shut down the server in the other terminal (by pressing `^C`).

## How to add tests or update expected output

Step 2 above can be run using `--expect response-NAME.json --regenerate` to (over-)write the output file.

## How to pretty-print Kore

Use `tools/rpc-kast.sh` to pretty-print the kore terms from JSON requests and responses into pretty K. Specify the compiled K definition as `K_DEFINITION`. For example:

```
$ K_DEFINITION=./resources/simplify-kompiled/ ../../tools/rpc-kast.sh --request test-simplify/state-evaluate-under-function.simplify
f ( 12 +Int 34 )
$ K_DEFINITION=./resources/simplify-kompiled/ ../../tools/rpc-kast.sh --simplify test-simplify/response-evaluate-under-function.json
f ( 46 )
```

`tools/rpc-kast.sh` assumes that you have `jq` and `pyk` on `PATH`. You can install `pyk` with `kup`.

## Automation

The shell script `runDirectoryTest.sh` runs the tests in a directory `test-NAME` given as its first argument. It will fail on the first error and automatically shut down the server. If you want to re-generate all the responses, just call `runDirectoryTest.sh` with `--regenerate`.
